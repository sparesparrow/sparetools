name: Publish Packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: "OpenSSL version to publish"
        required: true
        default: "3.3.2"

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify Cloudsmith token
        run: |
          if [ -z "${CLOUDSMITH_API_KEY}" ]; then
            echo "CLOUDSMITH_API_KEY secret missing"
            exit 1
          fi
        shell: bash
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Conan
        run: |
          python -m pip install --upgrade pip
          python -m pip install conan==2.21.0

      - name: Configure Conan remotes
        run: |
          conan profile detect --force
          conan remote add --force sparesparrow-conan https://conan.cloudsmith.io/sparesparrow-conan/openssl-conan/

      - name: Build sparetools-base
        run: conan create packages/sparetools-base --version=2.0.0 --build=missing

      - name: Build sparetools-cpython
        run: conan create packages/sparetools-cpython --version=3.12.7 --build=missing

      - name: Build sparetools-shared-dev-tools
        run: conan create packages/sparetools-shared-dev-tools --version=2.0.0 --build=missing

      - name: Build sparetools-bootstrap
        run: conan create packages/sparetools-bootstrap --version=2.0.0 --build=missing

      - name: Build sparetools-openssl-tools
        run: conan create packages/sparetools-openssl-tools --version=2.0.0 --build=missing

      - name: Build sparetools-openssl
        run: conan create packages/sparetools-openssl --version=${{ github.event.inputs.version }} --build=missing

      - name: Authenticate with Cloudsmith
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
        run: |
          conan remote login sparesparrow-conan sparesparrow --password "$CLOUDSMITH_API_KEY"

      - name: Upload packages
        run: |
          conan upload "sparetools-*/*" -r sparesparrow-conan --confirm --retry 3 --retry-wait 5

